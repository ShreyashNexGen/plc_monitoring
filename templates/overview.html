{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <div class="container">
        <h2>📊 PLC Data Overview</h2>

        <div class="top-controls">
            <!-- Filters -->
            <div class="filter-container">
                <label>📅 Filter by Date:</label>
                <input type="date" id="startDate">
                <input type="date" id="endDate">
                <button onclick="fetchFilteredData()" class="btn">Apply</button>
            </div>

            <!-- Download Excel Button -->
            <button onclick="downloadData()" class="btn download-btn">📥 Download Excel</button>
        </div>

        <!-- Summary Stats -->
        <div class="summary">
            <div class="summary-content">
                <h3>📌 Summary</h3>
                <p>⚡ <b>Average Speed:</b> <span id="avgSpeed">0</span> m/s</p>
                <p>📏 <b>Total Length:</b> <span id="totalLength">0</span> meters</p>
                <p>🔢 <b>Total Pieces:</b> <span id="totalPieces">0</span></p>
            </div>
        </div>
        
        

        <!-- Data Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>DateTime</th>
                        <th>Speed</th>
                        <th>Length</th>
                        <th>Pieces</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination">
            <button onclick="prevPage()" class="btn">⬅ Previous</button>
            <span id="pageNumber">1</span>
            <button onclick="nextPage()" class="btn">Next ➡</button>
        </div>
    </div>

    <script>
        let currentPage = 1;

        async function fetchData(page = 1) {
            const response = await fetch(`/api/data?page=${page}`);
            const result = await response.json();
            updateTable(result.data);
            document.getElementById("pageNumber").innerText = page;
        }

        async function fetchSummary() {
            const response = await fetch("/api/summary");
            const data = await response.json();
            document.getElementById("avgSpeed").innerText = data.avg_speed || "0";
            document.getElementById("totalLength").innerText = data.total_length || "0";
            document.getElementById("totalPieces").innerText = data.total_pieces || "0";
        }

        function updateTable(data) {
            const table = document.getElementById("dataTable");
            table.innerHTML = "";
            data.forEach(row => {
                table.innerHTML += `<tr>
                    <td>${row.datetime}</td>
                    <td>${row.speed} m/s</td>
                    <td>${row.length} meters</td>
                    <td>${row.pieces}</td>
                </tr>`;
            });
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                fetchData(currentPage);
            }
        }

        function nextPage() {
            currentPage++;
            fetchData(currentPage);
        }

        function downloadData() {
            window.location.href = "/download";
        }

        fetchData();
        fetchSummary();
    </script>
{% endblock %}
